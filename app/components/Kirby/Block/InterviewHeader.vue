<script setup lang="ts">
/**
 * InterviewHeader.vue
 *
 * A responsive header component for interview pages that displays:
 * - A background with customizable colors
 * - A cover image with optional focus point
 * - Interview quote, title and date
 *
 * The component adapts between mobile (stacked) and desktop (side-by-side) layouts
 */
import type { KirbyPageData } from '~/queries'
import { computed, onMounted, onUnmounted, ref } from 'vue'

// Get the current page data from the Kirby CMS
const page = usePage<KirbyPageData>()

// Get the current route to create matching view transition names (currently disabled)
// const route = useRoute()

// Determine if we're in SSR mode to avoid window reference errors
const isSSR = typeof window === 'undefined'

// Compute the background style based on available colors
const backgroundStyle = computed(() => {
  if (!page.value?.backgroundcolor) return 'transparent'

  if (page.value.secondarybackgroundcolor) {
    return `linear-gradient(135deg, ${page.value.backgroundcolor}, ${page.value.secondarybackgroundcolor})`
  }
  return page.value.backgroundcolor
})

// Reactive styles object for the header container
const interviewHeaderStyle = computed(() => ({
  background: backgroundStyle.value,
  color: page.value?.textcolor || 'white',
}))

// Create a date formatter for the interview date - memoized to avoid recreation
const dateFormatter = new Intl.DateTimeFormat('de-DE', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
})

// Track if the viewport is mobile size
const isMobile = ref(isSSR ? true : window.innerWidth < 768)

// Debounced resize handler for better performance
let resizeTimeout: ReturnType<typeof setTimeout> | null = null
const handleResize = () => {
  if (resizeTimeout) clearTimeout(resizeTimeout)
  resizeTimeout = setTimeout(() => {
    isMobile.value = window.innerWidth < 768 // md breakpoint in Tailwind is 768px
  }, 100) // 100ms debounce
}

// Set up responsive behavior - only in client-side
onMounted(() => {
  if (isSSR) return

  // Initial check
  isMobile.value = window.innerWidth < 768
  window.addEventListener('resize', handleResize, { passive: true })
})

// Clean up event listener
onUnmounted(() => {
  if (isSSR) return

  window.removeEventListener('resize', handleResize)
  if (resizeTimeout) clearTimeout(resizeTimeout)
})

// Compute text color style that only applies on desktop
const textColorStyle = computed(() => {
  // On mobile, return empty object to use default text-white class
  // On desktop, use the custom text color from page data
  return isMobile.value || !page.value?.textcolor
    ? {}
    : { color: page.value.textcolor }
})

// Determine if we should use the default white text color
const useDefaultTextColor = computed(() => {
  return isMobile.value || !page.value?.textcolor
})

/**
 * Format a date in the short format (DD. Month YYYY)
 * @param {Date} date - The date to format
 * @returns {string} Formatted date string
 */
const formatDateShort = (date: Date) => dateFormatter.format(date)

// Compute image attributes with fallbacks for better performance and accessibility
const imageAttrs = computed(() => {
  if (!page.value?.cover) {
    return {
      src: '',
      alt: '',
      style: { objectPosition: 'center' },
    }
  }

  return {
    src: page.value.cover.url || '',
    srcset: page.value.cover.srcset || '',
    width: page.value.cover.width,
    height: page.value.cover.height,
    alt: page.value.cover.alt || '',
    style: { objectPosition: page.value.cover.focus || 'center' },
    fetchpriority: 'high', // Prioritize loading this image
  }
})

// Determine if we have a valid cover image
const hasCoverImage = computed(() => Boolean(page.value?.cover?.url))
</script>

<template>
  <section id="interview-header"
    class="grid grid-cols-1 md:grid-cols-2 w-full md:h-[80vh] md:max-h-[100vh] overflow-hidden md:-mt-12" :style="{
      ...interviewHeaderStyle,
      // 'view-transition-name': `card-${route.path.replace(/^\/|\/$/g, '').replace(/\//g, '-')}`,
    }" aria-labelledby="interview-title" role="banner">
    <!-- Cover image container -->
    <figure v-if="hasCoverImage" id="interview-header-image"
      class="md:col-span-1 order-1 m-0 overflow-hidden md:h-full">
      <!-- Cover image with lazy loading and responsive sizing -->
      <img loading="eager" decoding="async" class="w-full h-auto md:h-full object-cover"
        sizes="(min-width: 768px) 50vw, 100vw" :style="{
          ...imageAttrs.style,
          // 'view-transition-name': `image-${route.path.replace(/^\/|\/$/g, '').replace(/\//g, '-')}`,
        }" v-bind="{ ...imageAttrs, style: undefined }" />
    </figure>

    <!-- Interview text content -->
    <div id="interview-header-text"
      class="relative not-prose order-2 grid md:col-span-1 items-end md:items-center justify-center justify-items-center py-36 md:py-12 text-center h-full z-[10]">
      <div class="column px-4" style="--columns: 12">
        <!-- Interview quote -->
        <h1
          class="transition-colors duration-300 px-2 text-lg font-bold font-sans italic md:max-w-[22ch] lg:text-3xl xl:text-4xl"
          :class="[useDefaultTextColor ? 'text-white' : '']" :style="{
            ...textColorStyle,
            // 'view-transition-name': `intro-${route.path.replace(/^\/|\/$/g, '').replace(/\//g, '-')}`,
          }">
          <span class="backdrop-opacity-70" aria-hidden="true">»</span>
          <span>{{ page.intro }}</span>
          <span class="opacity-70" aria-hidden="true">«</span>
        </h1>

        <!-- Interview title -->
        <h2 id="interview-title"
          class="transition-colors duration-300 opacity-85 mt-4 text-base font-bold tracking-wider font-sans"
          :class="[useDefaultTextColor ? 'text-white' : '']" :style="{
            ...textColorStyle,
            // 'view-transition-name': `title-${route.path.replace(/^\/|\/$/g, '').replace(/\//g, '-')}`,
          }">
          {{ page.title }}
        </h2>

        <!-- Interview date (if available) -->
        <time v-if="page.date" class="transition-colors duration-300 text-base opacity-85 block md:mt-2"
          :class="[useDefaultTextColor ? 'text-white' : '']" :style="textColorStyle" :datetime="page.date">
          {{ formatDateShort(new Date(page.date)) }}
        </time>
      </div>
    </div>
  </section>
</template>
